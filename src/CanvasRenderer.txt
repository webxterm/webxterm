import {Terminal} from "./Terminal";
import {
    ATTR_MODE_BOLD,
    // ATTR_MODE_CROSSED_OUT,
    ATTR_MODE_FAINT,
    ATTR_MODE_INVERSE, ATTR_MODE_INVISIBLE, ATTR_MODE_ITALIC,
    ATTR_MODE_NONE,
    // ATTR_MODE_RAPID_BLINK,
    ATTR_MODE_SLOW_BLINK, ATTR_MODE_UNDERLINE,
} from "./buffer/DataBlockAttribute";
import {Buffer} from "./buffer/Buffer";
import {CommonUtils} from "./common/CommonUtils";
import {CanvasSelection, SelectionPoint, SelectionRange} from "./CanvasSelection";
import {ScrollingRegion} from "./ScrollingRegion";
import {LineBuffer} from "./buffer/LineBuffer";




/**
 * ä½¿ç”¨Canvasæ¸²æŸ“çš„æ¸²æŸ“å™¨
 */
export class CanvasTextRenderer extends CanvasRenderer {




    /**
     * é€‰æ‹©å™¨æ¸²æŸ“çš„å—ï¼Œç”¨äºåé¢æŠ¹é™¤å·²ç»æ¸²æŸ“çš„åŒºåŸŸã€‚
     * item = startPX,width
     */
    private readonly selection_rendered_lines_rect: string[][] = [];

    // åˆ·æ–°å®šæ—¶å™¨
    private flushTimer: number = 0;

    constructor(terminal: Terminal) {
        super(terminal);
        this.textViewContext = this._term.textView.getContext("2d");
        // this.selectionViewContext = this._term.selectionView.getContext("2d");
        // this.cursorViewContext = this._term.cursorView.getContext("2d");
        // åˆå§‹åŒ–å¿«ç…§ä¿¡æ¯
        this.rendered_lines_rect = Array.from({length: this._term.rows}, () => []);
    }

    init(){


        // æ›´æ–°å­—ä½“å¤§å°ï¼Œå¹¶è®¡ç®—å­—ç¬¦å®½åº¦
        this.updateFontSize();

    }


    get measuredTextWidth(): number {
        return this._measuredTextWidth;
    }

    /**
     * è·å–ä¸€è¡Œçš„é«˜åº¦
     */
    get height(): number{
        return this._term.charHeight * this._term.preferences.canvasSizeMultiple;
    }


    /**
     * æ›´æ–°å­—ä½“å¤§å°å¹¶è·å–å­—ç¬¦å®½åº¦
     */
    updateFontSize(){

        // å­—ä½“å¤§å°
        const fontSize = this._term.preferences.fontSize.toLowerCase();
        console.info("CanvasRenderer......updateFontSize()...." + fontSize);

        let fs: number = 0;
        if(fontSize.indexOf("px") != -1){
            fs = parseInt(fontSize);
        } else if(fontSize.indexOf("pt") != -1){
            fs = parseInt(fontSize) / 0.75;
        }
        this.fontSize = fs * 2;
        // è·å–é»˜è®¤å­—ä½“
        if(this.textViewContext) {
            this.updateTextViewFont(DrawFontStyle.NORMAL);
            this.textViewContext.textBaseline = "bottom";
            this._measuredTextWidth = Math.round(this.textViewContext.measureText("w").width);
        }

        if(this.selectionViewContext) {
            this.updateSelectionViewFont(DrawFontStyle.NORMAL)
            this.selectionViewContext.textBaseline = "bottom";
        }
        if(this.cursorViewContext) {
            this.updateCursorViewFont(DrawFontStyle.NORMAL);
            this.cursorViewContext.textBaseline = "bottom";
        }
    }

    /**
     * æ›´æ–°textViewå­—ä½“
     * @param fontStyle
     */
    updateTextViewFont(fontStyle: DrawFontStyle){
        const font = this.getFont(fontStyle);
        if(this.textViewContext){
            this.textViewContext.font = font;
        }
    }

    /**
     * æ›´æ–°cursorViewå­—ä½“
     * @param fontStyle
     */
    updateCursorViewFont(fontStyle: DrawFontStyle){
        const font = this.getFont(fontStyle);
        if(this.cursorViewContext){
            this.cursorViewContext.font = font;
        }
    }

    /**
     * æ›´æ–°selectionViewå­—ä½“
     * @param fontStyle
     */
    updateSelectionViewFont(fontStyle: DrawFontStyle){
        const font = this.getFont(DrawFontStyle.NORMAL);
        if(this.selectionViewContext){
            this.selectionViewContext.font = font;
        }
    }

    // /**
    //  * è·å–ç¼“å­˜çš„è¡Œã€‚
    //  */
    // get savedLines(){
    //     return this._term.bufferSet.normal.saved_buf.lines;
    // }


    /**
     * æ˜¯å¦å‘½ä¸­å½“å‰å¿«ç…§
     */
    isHitCurrentFlushLines(){

        const buffer_size = this.activeBuffer.size;
        let top_index = Math.ceil(this._term.scrollView.scrollTop / this._term.charHeight)
            , bottom_index = top_index + buffer_size - 1;
        if(top_index < 0) top_index = 0;
        return top_index == this._csr.top_index && bottom_index == this._csr.bottom_index;
    }

    /**
     * è·å–å½“å‰æ˜¾ç¤ºçš„è¡Œã€‚
     */
    getCurrentWindowLines(): LineBuffer {

        const saved_buf = this._term.bufferSet.normal.saved_buf
            , saved_size = saved_buf.lines.length
            , saved_max_index = saved_size - 1
            , buffer_size = this.activeBuffer.size;

        let top_index = this._term.getOffsetTop()
            , bottom_index = top_index + buffer_size - 1;

        if(top_index < 0) top_index = 0;

        if(top_index == this._csr.top_index && bottom_index == this._csr.bottom_index){
            return this.activeBuffer.window_buf;
        }

        // é»˜è®¤
        let window_buf: LineBuffer;

        // ä¿ç•™åŒºæ˜¯ç©ºçš„ã€‚
        if(saved_size == 0){
            // æ˜¾ç¤ºçš„æ‰€æœ‰è¡Œéƒ½åœ¨ç¼“å†²åŒº
            window_buf = this.activeBuffer.change_buf;
        } else {
            if(bottom_index <= saved_max_index){
                // æ˜¾ç¤ºçš„æ‰€æœ‰è¡Œéƒ½åœ¨ä¿ç•™åŒºã€
                window_buf = new LineBuffer(0);
                window_buf.copyFrom(saved_buf, top_index, top_index + buffer_size);
            } else {
                if(saved_max_index <= top_index){
                    // æ˜¾ç¤ºçš„æ‰€æœ‰è¡Œéƒ½åœ¨ç¼“å†²åŒº
                    window_buf = this.activeBuffer.change_buf;
                } else {
                    // ä¿ç•™åŒºéœ€è¦è¯»å–çš„è¡Œæ•°
                    const saved_count = saved_max_index - top_index
                        // ç¼“å†²åŒºéœ€è¦è¯»å–çš„è¡Œæ•°
                        , buffer_count = buffer_size - saved_count;

                    window_buf = new LineBuffer(0);
                    if(saved_count > 0) window_buf.copyFrom(saved_buf, top_index, top_index + saved_count);
                    if(buffer_count > 0) window_buf.copyFrom(this.activeBuffer.change_buf, 0, buffer_count);

                }
            }
        }

        this._last_csr.top = this._csr.top;
        this._last_csr.bottom = this._csr.bottom;

        this._csr.top = top_index + 1;
        this._csr.bottom = bottom_index + 1;

        console.info("createSnapshot():_csr:" + JSON.stringify(this._csr) + ', last_csr:' + JSON.stringify(this._last_csr));
        return window_buf;
    }

    get csr(): ScrollingRegion {
        return this._csr;
    }

    /**
     * æ›´æ–°
     * @param rows
     * @param columns
     */
    resize(rows: number, columns: number){
        // this.startScrollYIndex = undefined;
        // this.stopScrollYIndex = undefined;
        // this.renderedBlocks = [];


        // æ›´æ–°å­—ä½“å¤§å°ï¼Œå¹¶è®¡ç®—å­—ç¬¦å®½åº¦
        this.updateFontSize();

        // é‡ç½®ä¸Šæ¬¡çš„æ ·è‰²
        this.last_fill_style = "";

        //
        console.info("resize....drawBuffer...");
        this.flushLines(this.getCurrentWindowLines(), false);

        // if(this.activeBuffer) this.drawDefaultBuffer();
    }


    // /**
    //  * ç»˜åˆ¶é»˜è®¤ç¼“å†²åŒº
    //  */
    // drawFlushLines(){
    //     const t1 = new Date().getTime();
    //     this.drawBuffer(this.getCurrentFlushLines(), false);
    //     console.info("drawDefaultBufferæ‰§è¡Œæ—¶é—´ï¼š" + (new Date().getTime() - t1))
    // }

    // /**
    //  * æ¸²æŸ“å½“å‰Buffer
    //  */
    // drawCurrentSnapshot(){
    //     this.drawBuffer(this.activeBuffer.flushLines, false);
    // }

    /**
     * æ¸²æŸ“å½“å‰Buffer
     * @param window_buf æ­£åœ¨æ˜¾ç¤ºçš„è¡Œ
     * @param fromScrollEvent æ˜¯å¦ä»æ»šåŠ¨çš„äº‹ä»¶æ¸²æŸ“
     */
    flushLines(window_buf: LineBuffer, fromScrollEvent: boolean){

        //
        this.activeBuffer.window_buf.removeLine(0, this.activeBuffer.window_buf.lines.length);
        this.activeBuffer.window_buf.copyFrom(window_buf, 0, window_buf.lines.length);

        // éœ€è¦é‡æ–°æ¸²æŸ“é€‰æ‹©èŒƒå›´
        if(fromScrollEvent){
            const returnCode = this.handleSelect();
            // 0: selection not running
            // 1: select all
            // 2: select
            // å…‰æ ‡æ¸²æŸ“
            this.drawCursor();
            if(returnCode == 1) return;
        }

        // console.info("drawBuffer...");

        // if(this.textViewContext){
        //     this.textViewContext.font = this.getFont();
        //     this.textViewContext.fillStyle = this._term.preferences.color;
        // }
        if(this.flushTimer > 0){
            return;
        }

        this.flushTimer = setTimeout(() => {
            for(let i = 0, len = this._term.rows; i < len; i++){
                this.drawLine(i + 1, window_buf);
            }
            // å…‰æ ‡æ¸²æŸ“
            this.drawCursor();
            this.flushTimer = 0;

        }, 0);
    }



    //
    // è€ƒè™‘æ€§èƒ½é—®é¢˜ï¼Œè¿™é‡Œé‡‡ç”¨è¿åŠ çš„æ–¹å¼
    // https://www.cnblogs.com/imyeah/p/es6-stringTemplate-performance-testing.html
    getFont(fontStyle: DrawFontStyle){
        const fontName = this._term.preferences.fontFamily.getFontName();
        if(fontStyle == DrawFontStyle.BOTH){
            return "italic bold " + this.fontSize + "px '" + fontName + "'";
        } else {
            if(fontStyle == DrawFontStyle.ITALIC){
                return "italic " + this.fontSize + "px '" + fontName + "'";
            }
            if(fontStyle == DrawFontStyle.BOLD){
                return "bold " + this.fontSize + "px '" + fontName + "'";
            }
            return this.fontSize + "px '" + fontName + "'";
        }
    }


    /**
     * æ¸…é™¤å½“å‰è¡Œ
     * @param y
     */
    clearLine(y: number){
        if(this.textViewContext){
            // ç©ºè¡Œä¸å¤„ç†ã€‚
            const rect = this.rendered_lines_rect[y - 1];
            if(!rect) return;
            const len = rect.length;
            if(len == 0) return;

            const height = this.height, startY = (y - 1) * height;
            for(let i = 0, startX, width; i < len; i++){
                [startX, width] = rect[i].split(",");
                this.textViewContext.clearRect(parseInt(startX), startY, parseInt(width), height);
            }
        }
    }

    /**
     * æ¸…å±
     */
    clearScreen(){
        if(this.textViewContext){
            this.textViewContext.clearRect(0, 0, this._term.textView.width, this._term.textView.height);
        }
    }

    /**
     * æ¢å¤æŸä¸€è¡Œï¼Œè¿™ä¸ªç”¨äºè”æƒ³è¾“å…¥åçš„ã€‚
     */
    restoreDrawLine() {
        // if(this.startScrollYIndex == undefined || this.stopScrollYIndex == undefined) return;
        //
        // const y = this._term.processComposing.anchorY;
        // const array = this.getActiveViewBlocks(this.startScrollYIndex, this.stopScrollYIndex);
        // const rendered = this.renderedBlocks[y - 1] || [];
        // const blocks = array[y - 1];
        // if(rendered.toString() != blocks.toString()){
        //     this.renderedBlocks[y - 1] = this.drawLine(y, blocks);
        // }
        // this.drawLine(y, blocks);
        // this.drawCursor();
    }

    /**
     * é‡æ–°æ¸²æŸ“æ­£åœ¨è”æƒ³è¾“å…¥çš„è¡Œ
     */
    drawComposingLine(){
        /*

        // if(this.startScrollYIndex == undefined || this.stopScrollYIndex == undefined) return;

        let activeComposing = this._term.composing;
        // if(this._term.processComposing.running){
        //     activeComposing = this._term.processComposing;
        // } else if(this._term.composing.running){
        //     activeComposing = this._term.composing;
        // } else {
        //     throw new Error("activeComposing is null");
        // }

        // å½“å‰å«æœ‰è”æƒ³è¾“å…¥
        let text = activeComposing.running ? activeComposing.update : activeComposing.end;
        // if(text == "") return;

        const y = activeComposing.anchorY;
        const array: string[][] = [];// this.getActiveViewBlocks(this.startScrollYIndex, this.stopScrollYIndex);
        let blocks = array[y - 1];

        this.clearCursor();
        // å–æ¶ˆé€‰æ‹©ã€‚
        if(this._term.selection.running) this.unselect(this._term.selection);

        if(this.textViewContext){

            // textBaseline = top: x, y = (å·¦ä¸Šè§’Xåæ ‡, å·¦ä¸Šè§’Yåæ ‡)
            // textBaseline = bottom: x, y = (å·¦ä¸Šè§’Xåæ ‡, å·¦ä¸‹è§’Yåæ ‡)
            this.textViewContext.textBaseline = "bottom";
            let width = Math.round(this.textViewContext.measureText("w").width);    // ä¸€ä¸ªå­—ç¬¦çš„å®½åº¦
            // let height = this._term.charHeight * this._term.preferences.canvasSizeMultiple;   // çŸ©å½¢çš„é«˜åº¦ = charHeight * 2(ç”»å¸ƒæ”¾å¤§çš„å€æ•°)
            let startX = 0;                 // å·¦ä¸Šè§’Xåæ ‡
            let startY = (y - 1) * this.height;  // å·¦ä¸Šè§’Yåæ ‡
            let textStartY = y * this.height;    // å·¦ä¸‹è§’Yåæ ‡
            blocks = CommonUtils.copyArray(blocks);  // å½“å‰è¡Œçš„æ‰€æœ‰å—
            let charCount = 0;  // å­—ç¬¦è®¡ç®—ï¼Œä¸»è¦ç”¨äº\t(åˆ¶è¡¨ç¬¦)ã€‚

            // è€ƒè™‘ä¼ é€’çš„å­—ç¬¦å«æœ‰4å­—èŠ‚çš„å­—ç¬¦ï¼Œå¦‚ï¼šğ ®·ğŸ˜€å‡ä¸º4ä¸ªå­—èŠ‚çš„é•¿åº¦ã€‚ åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º4å­—èŠ‚é•¿åº¦çš„æ–¹æ³•æ˜¯ï¼šc.codePointAt(0) > 0xFFFF;
            // https://es6.ruanyifeng.com/#docs/string-methods
            let j = 0,
                count = 0,
                composingStart = this.activeBuffer.x - 1,
                composingStop = composingStart;

            for(let chr of text){
                // ä¸¤ä¸ªå­—èŠ‚ã€å››ä¸ªå­—èŠ‚
                if(/[\u4E00-\u9FA5]|[\uFE30-\uFFA0]|[\u3000-\u303F]|[\u2E80-\u2EFF]/gi.test(chr)){
                    // å¦‚æœæ˜¯ä¸­æ–‡çš„è¯ï¼Œåˆ™ä¸‹ä¸€ä¸ªå­—ç¬¦éœ€è¦å¡«ç©ºç©ºæ ¼
                    // æ ¼å¼ï¼šå†…å®¹|len2
                    blocks.splice(composingStart + j, 0,
                        DataBlock.encode(chr, this._term.esParser.attribute, 2));
                    blocks.splice(composingStart + j + 1, 0, Buffer.newEmptyBlock());
                    composingStop += 1;
                    j++;
                } else {
                    blocks.splice(composingStart + j, 0,
                        DataBlock.encode(chr, this._term.esParser.attribute, 1));
                }
                j++;
                count++;
            }

            composingStop += count;

            this.clearLine(y);

            for (let x = 1,
                     len = blocks.length, block: DataBlock ; x <= len; x++) {
                block = DataBlock.decode(blocks[x - 1]);

                // ç©ºå—
                if (!block || block.length == 0) {
                    continue;
                }

                // charAt() ä¸æ”¯æŒ4å­—èŠ‚å­—ç¬¦ï¼Œå¦‚emojiè¡¨æƒ…
                // let value = block.data,
                //     invisible = block.isInvisible,
                //     underline = block.isUnderline,
                //     len2 = block.displaySize == 2;

                if(!block.isDefaultAttrs){
                    // æ²¡æœ‰æ¸²æŸ“çš„å—
                    // è§£ææ ·å¼
                    let color = block.colorClass;
                    let bgColor = block.backgroundColorClass;

                    // className:
                    //     "crossed-out",
                    //     "invisible",
                    //     "inverse",
                    //     "rapid-blink",
                    //     "slow-blink",
                    //     "underline",
                    //     "faint",
                    //     "bold"

                    // å­—ä½“æ–œä½“ï¼Œå­—ä½“åŠ ç²—
                    this.textViewContext.font = this.getFont(block.isItalic, block.isBold);

                    // èƒŒæ™¯é¢œè‰²ã€‚
                    if(!!bgColor){
                        if(this._term.preferences.paletteMap[bgColor])
                            bgColor = this._term.preferences.paletteMap[bgColor];
                    }
                    if(!bgColor) bgColor = this._term.preferences.backgroundColor;

                    // é¢œè‰²
                    if(!!color && this._term.preferences.paletteMap[color]) color = this._term.preferences.paletteMap[color];
                    if(!color) color = this._term.preferences.color;

                    if(block.isInverse){
                        // é¢œè‰²åè½¬
                        let tmpColor = color, tmpBgColor = bgColor;
                        if(!!tmpBgColor) color = tmpBgColor;
                        if(!!tmpColor) bgColor = tmpColor;
                    }

                    if(!!bgColor){
                        this.textViewContext.fillStyle = bgColor;
                        this.textViewContext.fillRect(startX, startY, width * block.displaySize, this.height);
                    }

                    if(!!color){
                        this.textViewContext.fillStyle = color;
                    }

                } else {
                    // è®¾ç½®é»˜è®¤çš„å­—ä½“ã€‚
                    this.textViewContext.font = this.getFont();
                    this.textViewContext.fillStyle = this._term.preferences.color;

                }

                // ç”»ä¸‹åˆ’çº¿ï¼Œé«˜åº¦ä¸º2ä¸ªåƒç´ 
                // å¦‚æœæ˜¯è”æƒ³è¾“å…¥ï¼Œé«˜åº¦ä¸º4ä¸ªåƒç´ ã€‚
                if(block.isUnderline || (composingStart < x && x <= composingStop)){
                    let underlineHeight = this._term.preferences.canvasSizeMultiple;
                    underlineHeight *= 2;
                    this.textViewContext.fillRect(startX, textStartY - underlineHeight, width * block.displaySize, underlineHeight);
                }


                // åˆ¶è¡¨ç¬¦
                // if(value === "\t"){
                //     const tabSize = this._term.preferences.tabSize;
                //     let spCount = tabSize - (charCount % tabSize);
                //
                //     for(let i = 0; i < spCount; i++){
                //         // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
                //         startX += width;
                //         charCount += 1;
                //     }
                //
                //     continue;
                // }

                // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
                if(!block.isInvisible && block.data != " "){
                    this.textViewContext.fillText(block.data, startX, textStartY);
                }

                startX += width * block.displaySize;
                charCount += block.displaySize;

                if(x == composingStop){
                    if(activeComposing.update.length > 0) {
                        console.info("drawComposingCursor...");
                        this.drawComposingCursor(startX, startY);
                    }
                }

            }

            if(activeComposing.update.length == 0 && this._term.cursor.show){

                this.drawCursor();
            }

            // console.info("startX:" + startX + ",startY: " + startY);

            return blocks;

        }


        return [];*/


        // }

        // this.drawLine(this._term.composing)

        // if(this.textViewContext){

        //     // textBaseline = top: x, y = (å·¦ä¸Šè§’Xåæ ‡, å·¦ä¸Šè§’Yåæ ‡)
        //     // textBaseline = bottom: x, y = (å·¦ä¸Šè§’Xåæ ‡, å·¦ä¸‹è§’Yåæ ‡)
        //     this.textViewContext.textBaseline = "bottom";
        //     let width = Math.round(this.textViewContext.measureText("w").width);    // ä¸€ä¸ªå­—ç¬¦çš„å®½åº¦
        //     // let height = this._term.charHeight * this._term.preferences.canvasSizeMultiple;   // çŸ©å½¢çš„é«˜åº¦ = charHeight * 2(ç”»å¸ƒæ”¾å¤§çš„å€æ•°)
        //     let startX = 0;                 // å·¦ä¸Šè§’Xåæ ‡
        //     let startY = (y - 1) * this.height;  // å·¦ä¸Šè§’Yåæ ‡
        //     let textStartY = y * this.height;    // å·¦ä¸‹è§’Yåæ ‡
        //     blocks = CommonUtils.copyArray(blocks);  // å½“å‰è¡Œçš„æ‰€æœ‰å—
        //     let charCount = 0;  // å­—ç¬¦è®¡ç®—ï¼Œä¸»è¦ç”¨äº\t(åˆ¶è¡¨ç¬¦)ã€‚
        //
        //     this.clearLine(y);
        //
        //     let composingStart = -1, composingStop = -1; // è”æƒ³è¾“å…¥å¼€å§‹å’Œåœæ­¢çš„Xåæ ‡ã€‚
        //     if(composing){
        //         // å½“å‰å«æœ‰è”æƒ³è¾“å…¥
        //         let text = composing.running ? composing.update : composing.end;
        //         composingStart = this.activeBuffer.x - 1;
        //         composingStop = composingStart;
        //
        //         // è€ƒè™‘ä¼ é€’çš„å­—ç¬¦å«æœ‰4å­—èŠ‚çš„å­—ç¬¦ï¼Œå¦‚ï¼šğ ®·ğŸ˜€å‡ä¸º4ä¸ªå­—èŠ‚çš„é•¿åº¦ã€‚ åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º4å­—èŠ‚é•¿åº¦çš„æ–¹æ³•æ˜¯ï¼šc.codePointAt(0) > 0xFFFF;
        //         // https://es6.ruanyifeng.com/#docs/string-methods
        //         let j = 0, count = 0;
        //         for(let chr of text){
        //             // ä¸¤ä¸ªå­—èŠ‚ã€å››ä¸ªå­—èŠ‚
        //             if(/[\u4E00-\u9FA5]|[\uFE30-\uFFA0]|[\u3000-\u303F]|[\u2E80-\u2EFF]/gi.test(chr)){
        //                 // å¦‚æœæ˜¯ä¸­æ–‡çš„è¯ï¼Œåˆ™ä¸‹ä¸€ä¸ªå­—ç¬¦éœ€è¦å¡«ç©ºç©ºæ ¼
        //                 // æ ¼å¼ï¼šå†…å®¹|len2
        //                 blocks.splice(composingStart + j, 0,
        //                     DataBlock.encode(chr, this._term.esParser.attribute, 2));
        //                 blocks.splice(composingStart + j + 1, 0, Buffer.newEmptyBlock());
        //                 composingStop += 1;
        //                 j++;
        //             } else {
        //                 blocks.splice(composingStart + j, 0,
        //                     DataBlock.encode(chr, this._term.esParser.attribute, 1));
        //             }
        //             j++;
        //             count++;
        //         }
        //
        //         composingStop += count;
        //
        //         this.clearCursor();
        //
        //         // å–æ¶ˆé€‰æ‹©ã€‚
        //         if(this._term.selection.running) this.unselect(this._term.selection);
        //     }
        //
        //     for (let x = 1, len = blocks.length, block: DataBlock ; x <= len; x++) {
        //         block = DataBlock.decode(blocks[x - 1]);
        //
        //         // ç©ºå—
        //         if (!block || block.length == 0) {
        //             // è”æƒ³è¾“å…¥å…‰æ ‡åˆ¶ä½œã€‚
        //             if(composing && x == composingStop){
        //                 // åœæ­¢å­—ç¬¦åé¢åˆ¶ä½œå…‰æ ‡ã€‚å®½åº¦ä¸º2.
        //                 if(composing.update.length > 0){
        //                     // è”æƒ³è¾“å…¥å­—ç¬¦é•¿åº¦å¤§äº0
        //                     this.drawComposingCursor(startX, startY);
        //
        //                 } else {
        //                     // åˆ¶ä½œæ™®é€šå…‰æ ‡ã€‚
        //                     this.drawCursor();
        //                 }
        //             }
        //             continue;
        //         }
        //
        //         // charAt() ä¸æ”¯æŒ4å­—èŠ‚å­—ç¬¦ï¼Œå¦‚emojiè¡¨æƒ…
        //         // let value = block.data,
        //         //     invisible = block.isInvisible,
        //         //     underline = block.isUnderline,
        //         //     len2 = block.displaySize == 2;
        //
        //         if(!block.isDefaultAttrs){
        //             // æ²¡æœ‰æ¸²æŸ“çš„å—
        //             // è§£ææ ·å¼
        //             let color = block.colorClass;
        //             let bgColor = block.backgroundColorClass;
        //
        //             // className:
        //             //     "crossed-out",
        //             //     "invisible",
        //             //     "inverse",
        //             //     "rapid-blink",
        //             //     "slow-blink",
        //             //     "underline",
        //             //     "faint",
        //             //     "bold"
        //
        //             // å­—ä½“æ–œä½“ï¼Œå­—ä½“åŠ ç²—
        //             this.textViewContext.font = this.getFont(block.isItalic, block.isBold);
        //
        //             // èƒŒæ™¯é¢œè‰²ã€‚
        //             if(!!bgColor){
        //                 if(this._term.preferences.paletteMap[bgColor])
        //                     bgColor = this._term.preferences.paletteMap[bgColor];
        //             }
        //             if(!bgColor) bgColor = this._term.preferences.backgroundColor;
        //
        //             // é¢œè‰²
        //             if(!!color && this._term.preferences.paletteMap[color]) color = this._term.preferences.paletteMap[color];
        //             if(!color) color = this._term.preferences.color;
        //
        //             if(block.isInverse){
        //                 // é¢œè‰²åè½¬
        //                 let tmpColor = color, tmpBgColor = bgColor;
        //                 if(!!tmpBgColor) color = tmpBgColor;
        //                 if(!!tmpColor) bgColor = tmpColor;
        //             }
        //
        //             if(!!bgColor){
        //                 this.textViewContext.fillStyle = bgColor;
        //                 this.textViewContext.fillRect(startX, startY, width * block.displaySize, this.height);
        //             }
        //
        //             if(!!color){
        //                 this.textViewContext.fillStyle = color;
        //             }
        //
        //         } else {
        //             // è®¾ç½®é»˜è®¤çš„å­—ä½“ã€‚
        //             this.textViewContext.font = this.getFont();
        //             this.textViewContext.fillStyle = this._term.preferences.color;
        //
        //         }
        //
        //         // ç”»ä¸‹åˆ’çº¿ï¼Œé«˜åº¦ä¸º2ä¸ªåƒç´ 
        //         // å¦‚æœæ˜¯è”æƒ³è¾“å…¥ï¼Œé«˜åº¦ä¸º4ä¸ªåƒç´ ã€‚
        //         if(isDisplayUnderline && (block.isUnderline || (composing && composingStart < x && x <= composingStop))){
        //             let underlineHeight = this._term.preferences.canvasSizeMultiple;
        //             if(composing) underlineHeight *= 2;
        //             this.textViewContext.fillRect(startX, textStartY - underlineHeight, width * block.displaySize, underlineHeight);
        //         }
        //
        //         // åˆ¶è¡¨ç¬¦
        //         // if(value === "\t"){
        //         //     const tabSize = this._term.preferences.tabSize;
        //         //     let spCount = tabSize - (charCount % tabSize);
        //         //
        //         //     for(let i = 0; i < spCount; i++){
        //         //         // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
        //         //         startX += width;
        //         //         charCount += 1;
        //         //     }
        //         //
        //         //     continue;
        //         // }
        //
        //         // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
        //         if(!block.isInvisible && block.data != " "){
        //             this.textViewContext.fillText(block.data, startX, textStartY);
        //         }
        //
        //         startX += width * block.displaySize;
        //         charCount += block.displaySize;
        //
        //         // è”æƒ³è¾“å…¥å…‰æ ‡åˆ¶ä½œã€‚
        //         if(composing && x == composingStop){
        //             // åœæ­¢å­—ç¬¦åé¢åˆ¶ä½œå…‰æ ‡ã€‚å®½åº¦ä¸º2.
        //             if(composing.update.length > 0){
        //                 // è”æƒ³è¾“å…¥å­—ç¬¦é•¿åº¦å¤§äº0
        //                 this.drawComposingCursor(startX, startY);
        //
        //             } else {
        //                 // åˆ¶ä½œæ™®é€šå…‰æ ‡ã€‚
        //                 this.drawCursor();
        //             }
        //         }
        //
        //
        //     }
        //
        //     return blocks;
        //
        // }
        //
        // return [];

    }

    /**
     * åˆ¶ä½œè¡Œ
     * @param y yåæ ‡ï¼Œåœ¨Canvaså¯è§åŒºåŸŸçš„çºµåæ ‡ï¼Œyçš„å¯é€‰å€¼ä¸º[1, this.activeBuffer.size]
     * @param window_buf
     */
    drawLine(y: number, window_buf: LineBuffer){

        if(this.textViewContext){

            let startX = 0;                 // å·¦ä¸Šè§’Xåæ ‡
            let charCount = 0;  // å­—ç¬¦è®¡ç®—ï¼Œä¸»è¦ç”¨äº\t(åˆ¶è¡¨ç¬¦)ã€‚

            const width = this._measuredTextWidth   // ä¸€ä¸ªå­—ç¬¦çš„å®½åº¦
                , height = this.height // é«˜åº¦
                , yIndex = y - 1   // å½“å‰çš„è¡Œçš„ç´¢å¼•
                , startY = yIndex * height  // å·¦ä¸Šè§’Yåæ ‡
                , textStartY = y * height   // å·¦ä¸‹è§’Yåæ ‡
                , blocks_data = window_buf.lines[yIndex]    // æ•°æ®
                , blocks_attr = window_buf.line_attrs[yIndex]   // å±æ€§
                , blocks_char_width = window_buf.line_char_widths[yIndex]   //
                , blocks_color = window_buf.line_colors[yIndex]
                , blocks_bg_color = window_buf.line_bg_colors[yIndex];

            // æ¸…é™¤ä¹‹å‰æ¸²æŸ“è¿‡çš„å†…å®¹
            this.clearLine(y);

            // ['100,100;']
            // ä¿å­˜æ¸²æŸ“ä¿¡æ¯ï¼Œä¸ºäº†åé¢å¯ä»¥å¿«é€Ÿæ¸…é™¤æ¸²æŸ“çš„å†…å®¹ã€‚
            let render_start = -1   // å¼€å§‹æ¸²æŸ“çš„x
              , render_width = 0;   // æ¸²æŸ“çš„é•¿åº¦
            const render_info = [];


            for (let x = 0
                     , w: number
                     , displaySize: number
                     , len = this._term.columns
                     , current_font_style: DrawFontStyle = DrawFontStyle.NORMAL
                     , current_fill_style: string = this._term.preferences.color
                     , hasUnderline // æ˜¯å¦å«æœ‰ä¸‹åˆ’çº¿
                     , isInvisible  // æ˜¯å¦å«æœ‰ä¸‹åˆ’çº¿
                     , isBold = false
                     , isInverse = false
                     , isFaint = false
                     , isItalic = false
                     , isSlowBlink = false
                     // , isRapidBlink = false
                     // , isCrossedOut = false
                     , attrMode; x < len; x++) {

                // å ä½ç¬¦
                if (!blocks_data[x] || blocks_data[x].length == 0) {
                    continue;
                }

                if(blocks_data[x] == " "){
                    // ç©ºå—
                    w = width;
                    displaySize = 1;

                    if(render_start >= 0 && render_width != 0){
                        render_info.push(render_start + "," + render_width);
                        // ç©ºæ ¼
                        render_start = -1;
                        render_width = 0;
                    }

                } else {

                    displaySize = blocks_char_width[x];
                    w = width * displaySize;

                    // charAt() ä¸æ”¯æŒ4å­—èŠ‚å­—ç¬¦ï¼Œå¦‚emojiè¡¨æƒ…
                    // let value = block.data,
                    //     invisible = block.isInvisible,
                    //     underline = block.isUnderline,
                    //     len2 = block.displaySize == 2;

                    if((attrMode = blocks_attr[x]) != ATTR_MODE_NONE){
                        // æ²¡æœ‰æ¸²æŸ“çš„å—
                        // è§£ææ ·å¼
                        let color = blocks_color[x];
                        let bgColor = blocks_bg_color[x];

                        // className:
                        //     "crossed-out",
                        //     "invisible",
                        //     "inverse",
                        //     "rapid-blink",
                        //     "slow-blink",
                        //     "underline",
                        //     "faint",
                        //     "bold"
                        if(isBold) isBold = false;
                        if(isInverse) isInverse = false;
                        if(isItalic) isItalic = false;
                        if(isFaint) isFaint = false;
                        if(isFaint) isFaint = false;
                        if(hasUnderline) hasUnderline = false;
                        if(isSlowBlink) isSlowBlink = false;
                        // if(isRapidBlink) isRapidBlink = false;
                        if(isInvisible) isInvisible = false;
                        // if(isCrossedOut) isCrossedOut = false;

                        // è§£æattr_mode...
                        switch (attrMode) {
                            case ATTR_MODE_NONE:
                                break;
                            case ATTR_MODE_BOLD:
                                isBold = true;
                                break;
                            case ATTR_MODE_INVERSE:
                                isInverse = true;
                                break;
                            case ATTR_MODE_ITALIC:
                                isItalic = true;
                                break;
                            case ATTR_MODE_FAINT:
                                isFaint = true;
                                break;
                            case ATTR_MODE_UNDERLINE:
                                hasUnderline = true;
                                break;
                            case ATTR_MODE_SLOW_BLINK:
                                isSlowBlink = true;
                                break;
                            // case ATTR_MODE_RAPID_BLINK:
                            //     isRapidBlink = true;
                            //     break;
                            case ATTR_MODE_INVISIBLE:
                                isInvisible = true;
                                break;
                            // case ATTR_MODE_CROSSED_OUT:
                            //     isCrossedOut = true;
                            //     break;
                            default:
                                // if(attrMode > ATTR_MODE_CROSSED_OUT){
                                //     attrMode -= ATTR_MODE_CROSSED_OUT;
                                //     isCrossedOut = true;
                                // }
                                if(attrMode >= ATTR_MODE_INVISIBLE){
                                    attrMode -= ATTR_MODE_INVISIBLE;
                                    isInvisible = true;
                                }
                                // if(attrMode >= ATTR_MODE_RAPID_BLINK){
                                //     attrMode -= ATTR_MODE_RAPID_BLINK;
                                //     isRapidBlink = true;
                                // }
                                if(attrMode >= ATTR_MODE_SLOW_BLINK){
                                    attrMode -= ATTR_MODE_SLOW_BLINK;
                                    isSlowBlink = true;
                                }
                                if(attrMode >= ATTR_MODE_UNDERLINE){
                                    attrMode -= ATTR_MODE_UNDERLINE;
                                    hasUnderline = true;
                                }
                                if(attrMode >= ATTR_MODE_FAINT){
                                    attrMode -= ATTR_MODE_FAINT;
                                    isFaint = true;
                                }
                                if(attrMode >= ATTR_MODE_ITALIC){
                                    attrMode -= ATTR_MODE_ITALIC;
                                    isItalic = true;
                                }
                                if(attrMode >= ATTR_MODE_INVERSE){
                                    attrMode -= ATTR_MODE_INVERSE;
                                    isInverse = true;
                                }
                                if(attrMode >= ATTR_MODE_BOLD){
                                    attrMode -= ATTR_MODE_BOLD;
                                    isBold = true;
                                }
                        }
                        // è§£æattr_mode...end...

                        // åŠ ç²—å’Œæ–œä½“
                        if(isItalic && isBold){
                            current_font_style = DrawFontStyle.BOTH;
                        } else {
                            // æ–œä½“
                            if(isItalic){
                                current_font_style = DrawFontStyle.ITALIC;
                            }
                            // åŠ ç²—
                            if(isBold){
                                current_font_style = DrawFontStyle.BOLD;
                            }
                        }

                        if(current_font_style != DrawFontStyle.NORMAL){
                            // ä¸æ˜¯æ­£å¸¸çš„å­—ä½“
                            this.updateTextViewFont(current_font_style);
                        }

                        // èƒŒæ™¯é¢œè‰²ã€‚
                        if(!!bgColor){
                            if(this._term.preferences.paletteMap[bgColor])
                                bgColor = this._term.preferences.paletteMap[bgColor];
                        }
                        if(!bgColor) bgColor = this._term.preferences.backgroundColor;

                        // é¢œè‰²
                        if(!!color && this._term.preferences.paletteMap[color]) color = this._term.preferences.paletteMap[color];
                        if(!color) color = this._term.preferences.color;

                        if(isInverse){
                            // é¢œè‰²åè½¬
                            let tmpColor = color, tmpBgColor = bgColor;
                            if(!!tmpBgColor) color = tmpBgColor;
                            if(!!tmpColor) bgColor = tmpColor;
                        }

                        if(!!bgColor){
                            this.textViewContext.fillStyle = bgColor;
                            this.textViewContext.fillRect(startX, startY, w, height);
                        }

                        if(!!color){
                            this.textViewContext.fillStyle = color;
                        }

                    } else {
                        // è®¾ç½®é»˜è®¤çš„å­—ä½“ã€‚
                        if(this.last_font_style != DrawFontStyle.NORMAL){
                            this.updateTextViewFont(DrawFontStyle.NORMAL);
                        }

                        if(this.last_fill_style != this._term.preferences.color){
                            this.textViewContext.fillStyle = this._term.preferences.color;
                        }

                        if(hasUnderline) hasUnderline = false;
                        if(isInvisible) isInvisible = false;
                    }



                    // ç”»ä¸‹åˆ’çº¿ï¼Œé«˜åº¦ä¸º2ä¸ªåƒç´ 
                    // å¦‚æœæ˜¯è”æƒ³è¾“å…¥ï¼Œé«˜åº¦ä¸º4ä¸ªåƒç´ ã€‚
                    if(hasUnderline){
                        let underlineHeight = this._term.preferences.canvasSizeMultiple;
                        this.textViewContext.fillRect(startX, textStartY - underlineHeight, w, underlineHeight);
                    }

                    // åˆ¶è¡¨ç¬¦
                    // if(value === "\t"){
                    //     const tabSize = this._term.preferences.tabSize;
                    //     let spCount = tabSize - (charCount % tabSize);
                    //
                    //     for(let i = 0; i < spCount; i++){
                    //         // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
                    //         startX += width;
                    //         charCount += 1;
                    //     }
                    //
                    //     continue;
                    // }

                    // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
                    // å¯è§ && data != " "
                    if(!isInvisible && blocks_data[x] != " "){
                        // ä¿å­˜æ¸²æŸ“çš„ä¿¡æ¯ï¼Œä¸ºäº†åæœŸå¯ä»¥å¿«é€Ÿæ¸…é™¤ã€‚
                        if(render_start == -1) render_start = startX;
                        render_width += w;

                        // é€šè¿‡æµ‹è¯•ï¼Œä¸€æ¬¡æ€§æ¸²æŸ“å¤šä¸ªå­—ç¬¦æ¯”ä¸€ä¸ªä¸€ä¸ªå­—ç¬¦çš„æ¸²æŸ“æ…¢ã€‚
                        this.textViewContext.fillText(blocks_data[x], startX, textStartY);

                    } else {
                        if(render_start >= 0 && render_width != 0){
                            render_info.push(render_start + "," + render_width);
                            // ç©ºæ ¼æˆ–éšè—çš„æ–‡æœ¬ã€‚
                            render_start = -1;
                            render_width = 0;
                        }
                    }

                }

                startX += w;
                charCount += displaySize;

                this.last_font_style = current_font_style;
                this.last_fill_style = current_fill_style;

            }

            if(render_start >= 0 && render_width != 0){
                render_info.push(render_start + "," + render_width);
                // ç©ºæ ¼æˆ–éšè—çš„æ–‡æœ¬ã€‚
            }

            this.rendered_lines_rect[yIndex] = render_info;

        }

    }

    // hideCursor(){
    //     this._term.cursorView.style.display = "none";
    // }
    //
    // showCursor(){
    //     this._term.cursorView.style.display = "";
    // }









    // /**
    //  * è·å–å½“å‰è¡Œçš„æ‰€æœ‰å—ã€‚
    //  * @param yIndex
    //  */
    // getBlocks(yIndex: number){
    //     return this.activeBuffer.flushedLines[yIndex];
    // }


    select2(selection: CanvasSelection){
        if(!selection.running) return;

        // æ¸…é™¤åŸæ¥çš„ã€‚
        // æ¸…é™¤ç”»å¸ƒ
        this.clearRect(selection);

        console.info("select2():_csr:" + JSON.stringify(this._csr) + ', last_csr:' + JSON.stringify(this._last_csr));
        console.info("select2:selection: " + JSON.stringify(selection));

        // å½“å‰æ˜¾ç¤ºçš„åŒºåŸŸæ²¡æœ‰é€‰ä¸­çš„æ–‡æœ¬ã€‚
        // åæ ‡ç‚¹
        // é€‰ä¸­åŒºåŸŸ
        // å¦‚ anchorY = 10, focusY = 11
        // minY = 10, maxY = 11
        // selection.offsetTop = 10
        const minY = Math.min(selection.anchorPoint.y, selection.focusPoint.y)
            , maxY = Math.max(selection.anchorPoint.y, selection.focusPoint.y);

        // if(minY == 0 && maxY == 0 && selection.anchorPoint.x == 0 && selection.focusPoint.x == 0) {
        //     console.info("Selectionæ²¡æœ‰é€‰ä¸­æ–‡æœ¬");
        //     return;
        // }

        // æœ€å°è¡Œå·ï¼Œæœ€å¤§è¡Œå·ï¼Œä»1å¼€å§‹
        // minY & maxY = è¡Œå· * height
        const minLineNum = minY / this.height + selection.offsetTop + 1
            , maxLineNum = maxY / this.height + selection.offsetTop + 1;

        // å½“å‰æ˜¾ç¤ºçš„è¡Œçš„å¼€å§‹çš„è¡Œå·ï¼Œä»1å¼€å§‹
        const topLineNum = this._csr.top, bottomLineNum = this._csr.bottom;

        console.info("top:" + topLineNum);

        // é€‰æ‹©æ–‡æœ¬åœ¨æ˜¾ç¤ºåŒºåŸŸä¸‹é¢ || é€‰æ‹©æ–‡æœ¬åœ¨æ˜¾ç¤ºåŒºåŸŸä¸Šé¢
        // è¿™ä¸¤ç§æƒ…å†µéƒ½ä¸ç”¨å¤„ç†ã€‚
        if(minLineNum < topLineNum && maxLineNum > bottomLineNum){
            console.info("select: é€‰ä¸­çš„æ–‡æœ¬ä¸åœ¨æ˜¾ç¤ºåŒºåŸŸã€‚")
            return;
        }

        // åˆ¤æ–­å½“å‰çš„displayLinesä¸­æ˜¯å¦å­˜åœ¨é€‰ä¸­åŒºåŸŸã€
        // selection anchorPoint Yç»å¯¹å€¼
        // displayRange Yç»å¯¹å€¼

        let startY: number, stopY: number;
        if(topLineNum < minLineNum) {
            startY = minLineNum;
            stopY = bottomLineNum < maxLineNum ? bottomLineNum : maxLineNum;
        } else {
            startY = topLineNum;
            stopY = bottomLineNum < maxLineNum ? bottomLineNum : maxLineNum;
        }

        // startY: ä»0å¼€å§‹
        // stopY: ä»0å¼€å§‹
        startY -= topLineNum;
        stopY -= topLineNum;

        const width = this._measuredTextWidth
            , fullWidth = this._term.columns * width
            , height = this.height
            , anchorY = startY * height
            , focusY = stopY * height;

        let startX = 0, stopX = 0;
        if(CommonUtils.indexPoint(selection.anchorPoint, selection.focusPoint)){
            // startXç¬¬ä¸€è¡Œä»selection.anchorPoint.xå¼€å§‹
            // å…¶ä»–è¡Œä»0å¼€å§‹ã€‚
            if(topLineNum <= minLineNum) {
                startX = selection.anchorPoint.x;
            }
            // æœ€åä¸€è¡Œä¸º0
            // å…¶ä»–è¡Œä¸ºselection.focusPoint.x
            if(bottomLineNum < maxLineNum){
                stopX = fullWidth;
            } else {
                stopX = selection.focusPoint.x;
            }
        } else if(CommonUtils.reverseIndexPoint(selection.anchorPoint, selection.focusPoint)){
            if(topLineNum <= minLineNum) {
                startX = selection.focusPoint.x;
            }
            // æœ€åä¸€è¡Œä¸º0
            // å…¶ä»–è¡Œä¸ºselection.focusPoint.x
            if(bottomLineNum < maxLineNum){
                stopX = fullWidth;
            } else {
                stopX = selection.anchorPoint.x;
            }
        }

        const anchorX = startX, focusX = stopX;

        // ä¸´æ—¶ä¿å­˜selection.ranges
        let ranges = selection.ranges;
        selection.clearRanges();

        for(let y = anchorY,
                x = 0,
                w = 0,
                yIndex = 0,
                startIndex = 0,
                stopIndex = -1,
                i = 0; y <= focusY; y+=height, i++){
            if(y == anchorY) {

                if(y == focusY){
                    // å…¨éƒ¨åœ¨ä¸€è¡Œ
                    startIndex = Math.floor(anchorX / width);
                    stopIndex = Math.floor(focusX / width);
                    w = focusX - anchorX;       // è€ƒè™‘å ä¸¤ä¸ªä½ç½®çš„emojiè¡¨æƒ…
                } else {
                    // ç¬¬ä¸€è¡Œ
                    startIndex = Math.floor(anchorX / width);
                    stopIndex = -1;
                    w = fullWidth - anchorX;
                }
                x = anchorX;
            } else if(y == focusY){
                // æœ€åä¸€è¡Œ
                x = 0;
                w = focusX;     // è€ƒè™‘å ä¸¤ä¸ªä½ç½®çš„emojiè¡¨æƒ…
                startIndex = 0;
                stopIndex = Math.floor(focusX / width);
            } else {
                // ä¸­é—´è¡Œ
                x = 0;
                w = fullWidth;
                startIndex = 0;
                stopIndex = -1;
            }

            // if(ranges[i]
            //     && CommonUtils.isSamePoint(ranges[i].startPoint, new SelectionPoint(x, y))
            //     && CommonUtils.isSamePoint(ranges[i].stopPoint, new SelectionPoint(w + x, y))){
            //     // console.info("ç¬¬" + (i + 1) + "è¡Œä¸ç”¨æ¸²æŸ“");
            //     selection.ranges[i] = ranges[i];
            //     continue;
            // }

            // [0, this._term.rows - 1]
            yIndex = Math.floor(y / height);
            // console.info("yIndex:" + yIndex + ", startIndex:" + startIndex + ", stopIndex:" + stopIndex);

            let data_arr = this.activeBuffer.window_buf.lines[yIndex];
            // yIndexæœ€å¤§å€¼ï¼šthis._term.rows - 1
            if(yIndex > this._term.rows - 1){
                // []
                continue;
            }

            let selectedTextArray;
            if(stopIndex == -1){
                selectedTextArray = data_arr.slice(startIndex, data_arr.length);
            } else {
                selectedTextArray = data_arr.slice(startIndex, stopIndex);
            }

            // console.info(blocks);
            // console.info(selectedBlocks);

            // æ¸…é™¤å½“å‰è¡Œ
            // this.clearLine(yIndex + 1);
            // if(this.selectionViewContext){
            //     this.selectionViewContext.clearRect(w + x, y, fullWidth, this.height);
            // }

            // å¦‚æœç¬¬ä¸€è¡Œæ˜¯ç©ºè¡Œçš„è¯ï¼Œä¸ç”¨é€‰ä¸­ã€‚
            let selectedContent = this.handleSelectedContent(selectedTextArray);
            // let textLength = selectedTextArray.length;
            // if(y == anchorY && textLength == 0){
            //     selection.ranges[i] = new SelectionRange(0, 0, 0, 0, "", 0);
            //     continue;
            // }


            // console.info("selectedTextArray.length=" + selectedTextArray.length + ", focusX=" + (focusX / width));

            // å¦‚æœfocusXå¤§äºå½“å‰è¡Œçš„æ–‡æœ¬çš„åæ ‡å€¼çš„è¯ï¼Œå½“å‰è¡Œå…¨é€‰ã€‚
            // if(y == focusY){
            //     if(textLength < Math.floor((focusX / width))){
            //         w = fullWidth;
            //     }
            // }
            this.drawSelectedText(x, y, height, width);
            selection.ranges[i] = new SelectionRange(x, y, w + x, y, selectedContent.join(""));

        }

        // åˆ¤æ–­å“ªè¡Œæ˜¯å¤šä½™çš„ï¼ˆè¢«å–æ¶ˆé€‰ä¸­çš„ï¼‰
        // selection.ranges å’Œ rangesåšå¯¹æ¯”
        // if(selection.ranges.length < ranges.length){
        //     // å–æ¶ˆé€‰ä¸­çš„è¡Œåº”è¯¥æ˜¯ranges.length - selection.ranges.length
        //     for(let i = selection.ranges.length, len = ranges.length; i < len; i++){
        //         if(this.selectionViewContext){
        //             this.selectionViewContext.clearRect(ranges[i].startPoint.x,
        //                 ranges[i].startPoint.y, ranges[i].stopPoint.x - ranges[i].startPoint.x, this.height);
        //         }
        //     }
        // }



    }

    /**
     * å†…å®¹é€‰æ‹©
     * @param selection
     */
    select(selection: CanvasSelection) {
        // console.info(JSON.stringify(selection));
        if(this.selectionViewContext){

            const width = this._measuredTextWidth
                , height = this.height
                , fullWidth = this._term.columns * width;

            // console.info("fullWidth:" + fullWidth);
            // å¼€å§‹åæ ‡(x, y)
            // ç»“æŸåæ ‡(x, y)
            const anchorX = selection.anchorPoint.x
                , anchorY = selection.anchorPoint.y
                ,  focusX = selection.focusPoint.x
                ,  focusY = selection.focusPoint.y;

            // let anchorPoint = new SelectionPoint(anchorX, anchorY),
            //     focusPoint = new SelectionPoint(focusX, focusY);

            // åˆ¤æ–­ä¸¤ä¸ªç‚¹æ˜¯å¦ç›¸åŒ
            // console.info("åˆ¤æ–­ä¸¤ä¸ªç‚¹æ˜¯å¦ç›¸åŒï¼š" + (this.lastAnchorPoint.x == anchorX
            //     && this.lastAnchorPoint.y == anchorY
            //     && this.lastFocusPoint.x == focusX
            //     && this.lastFocusPoint.y == focusY));
            // console.info(JSON.stringify(this.lastAnchorPoint) + JSON.stringify(this.lastFocusPoint));
            // console.info("anchorYï¼š" + anchorY + "ï¼Œ anchorXï¼š" + anchorX + "ï¼ŒfocusXï¼š" + focusX + "ï¼ŒfocusYï¼š" + focusY);
            //
            if(CommonUtils.isSamePoint(this.lastAnchorPoint, selection.anchorPoint)
                && CommonUtils.isSamePoint(this.lastFocusPoint, selection.focusPoint)){
                // ä½ç½®ç›¸åŒï¼Œä¸ç”¨å¤„ç†ã€‚
                console.info("ä½ç½®ç›¸åŒï¼Œä¸ç”¨å¤„ç†ã€‚");
                return;
            }
            //

            // ä¸Šæ¬¡é€‰æ‹©çš„ç‚¹
            if(CommonUtils.indexPoint(selection.anchorPoint, selection.focusPoint)){
                // æ­£å‘é€‰æ‹©
                // ä»ä¸Šå¾€ä¸‹é€‰æ‹©ã€‚
                // console.info("æ­£å‘é€‰æ‹©ã€‚ã€‚ã€‚");
                if(this.isReverseSelect){
                    // é¦–å…ˆéœ€è¦å–æ¶ˆä¹‹å‰é€‰ä¸­çš„ã€‚å¦‚æœä¹‹å‰æ˜¯åå‘é€‰æ‹©çš„è¯ã€‚
                    this.unselect(selection);
                }
                this.isReverseSelect = false;

                // ä¸´æ—¶ä¿å­˜selection.ranges
                let ranges = selection.ranges;
                selection.clearRanges();

                for(let y = anchorY,
                        x = 0,
                        w = 0,
                        yIndex = 0,
                        startIndex = 0,
                        stopIndex = -1,
                        i = 0; y <= focusY; y+=height, i++){
                    if(y == anchorY) {

                        if(y == focusY){
                            // å…¨éƒ¨åœ¨ä¸€è¡Œ
                            startIndex = Math.floor(anchorX / width);
                            stopIndex = Math.floor(focusX / width);
                            w = focusX - anchorX;       // è€ƒè™‘å ä¸¤ä¸ªä½ç½®çš„emojiè¡¨æƒ…
                        } else {
                            // ç¬¬ä¸€è¡Œ
                            startIndex = Math.floor(anchorX / width);
                            stopIndex = -1;
                            w = fullWidth - anchorX;
                        }
                        x = anchorX;
                    } else if(y == focusY){
                        // æœ€åä¸€è¡Œ
                        x = 0;
                        w = focusX;     // è€ƒè™‘å ä¸¤ä¸ªä½ç½®çš„emojiè¡¨æƒ…
                        startIndex = 0;
                        stopIndex = Math.floor(focusX / width);
                    } else {
                        // ä¸­é—´è¡Œ
                        x = 0;
                        w = fullWidth;
                        startIndex = 0;
                        stopIndex = -1;
                    }

                    if(ranges[i]
                        && CommonUtils.isSamePoint(ranges[i].startPoint, new SelectionPoint(x, y))
                        && CommonUtils.isSamePoint(ranges[i].stopPoint, new SelectionPoint(w + x, y))){
                        // console.info("ç¬¬" + (i + 1) + "è¡Œä¸ç”¨æ¸²æŸ“");
                        selection.ranges[i] = ranges[i];
                        continue;
                    }

                    // [0, this._term.rows - 1]
                    yIndex = Math.floor(y / height);
                    // console.info("yIndex:" + yIndex + ", startIndex:" + startIndex + ", stopIndex:" + stopIndex);

                    let data_arr = this.activeBuffer.window_buf.lines[yIndex];
                    // yIndexæœ€å¤§å€¼ï¼šthis._term.rows - 1
                    if(yIndex > this._term.rows - 1){
                        // []
                        continue;
                    }

                    let selectTextArray;
                    if(stopIndex == -1){
                        selectTextArray = data_arr.slice(startIndex, data_arr.length);
                    } else {
                        selectTextArray = data_arr.slice(startIndex, stopIndex);
                    }

                    // console.info(blocks);
                    // console.info(selectedBlocks);

                    // æ¸…é™¤å½“å‰è¡Œ
                    // this.clearLine(yIndex + 1);
                    if(this.selectionViewContext){
                        this.selectionViewContext.clearRect(w + x, y, fullWidth, this.height);
                    }

                    // å¦‚æœç¬¬ä¸€è¡Œæ˜¯ç©ºè¡Œçš„è¯ï¼Œä¸ç”¨é€‰ä¸­ã€‚
                    let selectedContent = this.handleSelectedContent(selectTextArray);

                    let textLength = selectedContent.length;
                    if(y == anchorY && textLength == 0){
                        selection.ranges[i] = new SelectionRange(0, 0, 0, 0, "");
                        continue;
                    }

                    // è€ƒè™‘ä¸­æ–‡å ä½ç¬¦çš„é—®é¢˜
                    if(textLength > 0){
                        if(selectedContent[0] === ""){
                            // ä¸­æ–‡å ä½ç¬¦
                            if(stopIndex == -1){
                                selectTextArray = data_arr.slice(startIndex + 1, data_arr.length);
                            } else {
                                selectTextArray = data_arr.slice(startIndex + 1, stopIndex);
                            }

                            w = w - width;
                            x = x + width;
                        }
                    }

                    // console.info("selectedTextArray.length=" + selectedTextArray.length + ", focusX=" + (focusX / width));

                    // å¦‚æœfocusXå¤§äºå½“å‰è¡Œçš„æ–‡æœ¬çš„åæ ‡å€¼çš„è¯ï¼Œå½“å‰è¡Œå…¨é€‰ã€‚
                    // if(y == focusY){
                    //     if(textLength < Math.floor((focusX / width))){
                    //         w = fullWidth;
                    //     }
                    // }
                    this.drawSelectedText(x, y, height, width);
                    selection.ranges[i] = new SelectionRange(x, y, w + x, y, selectedContent.join(""));

                }

                // åˆ¤æ–­å“ªè¡Œæ˜¯å¤šä½™çš„ï¼ˆè¢«å–æ¶ˆé€‰ä¸­çš„ï¼‰
                // selection.ranges å’Œ rangesåšå¯¹æ¯”
                if(selection.ranges.length < ranges.length){
                    // å–æ¶ˆé€‰ä¸­çš„è¡Œåº”è¯¥æ˜¯ranges.length - selection.ranges.length
                    for(let i = selection.ranges.length, len = ranges.length; i < len; i++){
                        if(this.selectionViewContext){
                            this.selectionViewContext.clearRect(ranges[i].startPoint.x,
                                ranges[i].startPoint.y, ranges[i].stopPoint.x - ranges[i].startPoint.x, this.height);
                        }
                    }
                }

                // console.info(selection.ranges);



            } else if(CommonUtils.reverseIndexPoint(selection.anchorPoint, selection.focusPoint)){
                // åå‘é€‰æ‹©
                // ä»ä¸‹å¾€ä¸Šé€‰æ‹©
                if(!this.isReverseSelect){
                    // é¦–å…ˆéœ€è¦å–æ¶ˆä¹‹å‰é€‰ä¸­çš„ã€‚å¦‚æœä¹‹å‰æ˜¯æ­£é€‰é€‰æ‹©çš„è¯ã€‚
                    this.unselect(selection);
                }

                this.isReverseSelect = true;

                // console.info("åå‘é€‰æ‹©");
                //
                // ä¸´æ—¶ä¿å­˜selection.ranges
                let ranges = selection.ranges;
                selection.clearRanges();

                // console.info("len=" + Math.floor((anchorY - focusY) / height) + ", anchorY=" + anchorY + ", focusY=" + focusY + ", height=" + height);

                // åå‘éå†ã€‚
                for(let y = 0,
                        x = 0,
                        w = 0,
                        i = 0,
                        // len = Math.floor((anchorY - focusY) / height),
                        startIndex = 0,
                        stopIndex = 0; y <= anchorY; y += height, i++){

                    if(y < focusY){
                        // console.info("y=" + y);
                        selection.ranges[i] = new SelectionRange(0, y, 0, y, "", true);

                        // æ¸…é™¤å½“å‰è¡Œ
                        if(!ranges[i] || (ranges[i].startPoint.x == 0 && ranges[i].stopPoint.x == 0)){
                            // ä¸¤ä¸ªç‚¹ä¸ºåŸç‚¹ã€‚
                            // startPointX == stopPointX
                            continue
                        } else {
                            // å¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™æ¸…æ‰
                            if(this.selectionViewContext){
                                this.selectionViewContext.clearRect(0, y, fullWidth, this.height);
                            }
                        }
                        continue;
                    }

                    if(y == focusY) {
                        if(y == anchorY){
                            // å…¨éƒ¨åœ¨ä¸€è¡Œ
                            startIndex = Math.floor(focusX / width);
                            stopIndex = Math.floor(anchorX / width);
                            w = anchorX - focusX;   // éœ€è¦æ¸²æŸ“çš„å®½åº¦
                        } else {
                            // ç¬¬ä¸€è¡Œ
                            startIndex = Math.floor(focusX / width);
                            stopIndex = -1;
                            w = fullWidth - focusX; // éœ€è¦æ¸²æŸ“çš„å®½åº¦
                        }
                        x = focusX;

                        // ç¬¬ä¸€è¡Œå–æ¶ˆé€‰ä¸­
                        // å¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™æ¸…æ‰
                        if(this.selectionViewContext){
                            this.selectionViewContext.clearRect(0, y, x, this.height);
                        }

                    } else if(y == anchorY){
                        // æœ€åä¸€è¡Œ
                        x = 0;
                        w = anchorX;    // éœ€è¦æ¸²æŸ“çš„å®½åº¦
                        startIndex = 0;
                        stopIndex = Math.floor(anchorX / width);
                    } else {
                        // ä¸­é—´è¡Œ
                        x = 0;
                        w = fullWidth;  // éœ€è¦æ¸²æŸ“çš„å®½åº¦
                        startIndex = 0;
                        stopIndex = -1;
                    }

                    // console.info("selection=" + JSON.stringify(selection));

                    // åˆ¤æ–­å“ªè¡Œä¸ç”¨é‡æ–°æ¸²æŸ“ã€‚
                    // ä»åº•éƒ¨å¼€å§‹ã€‚
                    if(ranges[i]
                        && CommonUtils.isSamePoint(ranges[i].startPoint, new SelectionPoint(x, y))
                        && CommonUtils.isSamePoint(ranges[i].stopPoint, new SelectionPoint(w + x, y))){
                        // console.info("ç¬¬" + (i + 1) + "è¡Œä¸ç”¨æ¸²æŸ“");
                        selection.ranges[i] = ranges[i];
                        continue;
                    }


                    // [0, this._term.rows - 1]
                    // console.info("i:" + i + ", startIndex:" + startIndex + ", stopIndex:" + stopIndex);

                    let data_arr = this.activeBuffer.window_buf.lines[i];
                    // yIndexæœ€å¤§å€¼ï¼šthis._term.rows - 1
                    if(i > this._term.rows - 1){
                        // []
                        continue;
                    }

                    let selectTextArray;
                    if(stopIndex == -1){
                        selectTextArray = data_arr.slice(startIndex, data_arr.length);
                    } else {
                        selectTextArray = data_arr.slice(startIndex, stopIndex);
                    }

                    // è·å–é€‰ä¸­çš„å†…å®¹
                    let selectedContent = this.handleSelectedContent(selectTextArray);
                    if(selectedContent.length > 0){
                        if(selectedContent[0] === ""){
                            // ä¸­æ–‡å ä½ç¬¦
                            if(stopIndex == -1){
                                selectTextArray = data_arr.slice(startIndex - 1, data_arr.length);
                            } else {
                                selectTextArray = data_arr.slice(startIndex - 1, stopIndex);
                            }

                            w = w + width;
                            x = x - width;
                        }
                    }

                    // console.info("selectedBlocks:" + JSON.stringify(selectedBlocks));

                    this.drawSelectedText(x, y, height, width);
                    selection.ranges[i] = new SelectionRange(x, y, w + x, y, selectedContent.join(""));

                }


            } else {
                // ä¸¤ä¸ªç‚¹ç›¸åŒã€‚
                // console.info("ä¸¤ä¸ªç‚¹ç›¸åŒã€‚");
            }

            selection.running = true;

            this.lastAnchorPoint = selection.anchorPoint;
            this.lastFocusPoint = selection.focusPoint;

            this._term.clipboard.value = selection.selectedContent;
            this._term.clipboard.select();

            console.info("select:selectedContent:\"" + selection.selectedContent + "\"");

        }

    }

    /**
     * å¤„ç†é€‰ä¸­çš„å†…å®¹ï¼Œå¦‚æœåé¢å…¨éƒ¨éƒ½æ˜¯ç©ºæ ¼çš„è¯ï¼Œå°±ä¸ç”¨è¿”å›ç©ºæ ¼ï¼Œåªè¿”å›ç©ºè¡Œã€‚
     * @param selectTextArray
     */
    handleSelectedContent(selectTextArray: string[]){
        let validIndex = -1, result = [];
        for(let i = 0, len = selectTextArray.length; i < len; i++){
            if(selectTextArray[i] != " "){
                validIndex = i;
            }
            result[i] = selectTextArray[i];
        }
        if(validIndex == -1){
            return [];
        }
        return result.slice(0, validIndex + 1);
    }

    /**
     * ç»˜åˆ¶é€‰ä¸­çš„æ–‡å­—
     * @param startX
     * @param startY
     // * @param selectedWidth é€‰ä¸­åŒºåŸŸçš„å®½åº¦
     * @param height å½“å‰è¡Œçš„é«˜åº¦
     * @param charWidth å­—ç¬¦å®½åº¦
     */
    drawSelectedText(startX: number
                     , startY: number
                     // , selectedWidth: number
                     , height: number
                     , charWidth: number): void{
        // æ¸²æŸ“é€‰ä¸­é¢œè‰²ã€‚
        if(this.selectionViewContext){

            // è®¡ç®—ä»ç¬¬å‡ ä¸ªå­—ç¬¦å¼€å§‹
            let charCount = startX / charWidth
                , textStartY = startY + height
                , yIndex = startY / height
                , xIndex = charCount
                , blocks_data = this.activeBuffer.window_buf.lines[yIndex]    // æ•°æ®
                , blocks_attr = this.activeBuffer.window_buf.line_attrs[yIndex]   // å±æ€§
                , blocks_char_width = this.activeBuffer.window_buf.line_char_widths[yIndex]   //
                , blocks_color = this.activeBuffer.window_buf.line_colors[yIndex]
                , blocks_bg_color = this.activeBuffer.window_buf.line_bg_colors[yIndex];

            for (let x = xIndex
                     , len = blocks_data.length
                     , current_font_style: DrawFontStyle = DrawFontStyle.NORMAL
                     , hasUnderline // æ˜¯å¦å«æœ‰ä¸‹åˆ’çº¿
                     , isInvisible  // æ˜¯å¦å«æœ‰ä¸‹åˆ’çº¿
                     , isBold = false
                     , isInverse = false
                     , isFaint = false
                     , isItalic = false
                     , isSlowBlink = false
                     // , isRapidBlink = false
                     // , isCrossedOut = false
                     , attrMode; x <= len; x++) {


                // ç©ºå—
                if (!blocks_data[x] || blocks_data[x].length == 0) continue;

                // let value = block.data;
                // let invisible = block.isInvisible, underline = block.isUnderline;
                let selectionColor;
                let selectionTextColor;

                if((attrMode = blocks_attr[x]) != ATTR_MODE_NONE){
                    // æ²¡æœ‰æ¸²æŸ“çš„å—
                    // è§£ææ ·å¼
                    // let array = DataBlockAttribute.parseClassName(CommonUtils.substring(block, 2));
                    // let className = array[0];
                    let color = blocks_color[x], bgColor = blocks_bg_color[x];

                    if(isBold) isBold = false;
                    if(isInverse) isInverse = false;
                    if(isItalic) isItalic = false;
                    if(isFaint) isFaint = false;
                    if(isFaint) isFaint = false;
                    if(hasUnderline) hasUnderline = false;
                    if(isSlowBlink) isSlowBlink = false;
                    // if(isRapidBlink) isRapidBlink = false;
                    if(isInvisible) isInvisible = false;
                    // if(isCrossedOut) isCrossedOut = false;

                    // è§£æattr_mode...
                    switch (attrMode) {
                        case ATTR_MODE_NONE:
                            break;
                        case ATTR_MODE_BOLD:
                            isBold = true;
                            break;
                        case ATTR_MODE_INVERSE:
                            isInverse = true;
                            break;
                        case ATTR_MODE_ITALIC:
                            isItalic = true;
                            break;
                        case ATTR_MODE_FAINT:
                            isFaint = true;
                            break;
                        case ATTR_MODE_UNDERLINE:
                            hasUnderline = true;
                            break;
                        case ATTR_MODE_SLOW_BLINK:
                            isSlowBlink = true;
                            break;
                        // case ATTR_MODE_RAPID_BLINK:
                        //     isRapidBlink = true;
                        //     break;
                        case ATTR_MODE_INVISIBLE:
                            isInvisible = true;
                            break;
                        // case ATTR_MODE_CROSSED_OUT:
                        //     isCrossedOut = true;
                        //     break;
                        default:
                            // if(attrMode > ATTR_MODE_CROSSED_OUT){
                            //     attrMode -= ATTR_MODE_CROSSED_OUT;
                            //     isCrossedOut = true;
                            // }
                            if(attrMode >= ATTR_MODE_INVISIBLE){
                                attrMode -= ATTR_MODE_INVISIBLE;
                                isInvisible = true;
                            }
                            // if(attrMode >= ATTR_MODE_RAPID_BLINK){
                            //     attrMode -= ATTR_MODE_RAPID_BLINK;
                            //     isRapidBlink = true;
                            // }
                            if(attrMode >= ATTR_MODE_SLOW_BLINK){
                                attrMode -= ATTR_MODE_SLOW_BLINK;
                                isSlowBlink = true;
                            }
                            if(attrMode >= ATTR_MODE_UNDERLINE){
                                attrMode -= ATTR_MODE_UNDERLINE;
                                hasUnderline = true;
                            }
                            if(attrMode >= ATTR_MODE_FAINT){
                                attrMode -= ATTR_MODE_FAINT;
                                isFaint = true;
                            }
                            if(attrMode >= ATTR_MODE_ITALIC){
                                attrMode -= ATTR_MODE_ITALIC;
                                isItalic = true;
                            }
                            if(attrMode >= ATTR_MODE_INVERSE){
                                attrMode -= ATTR_MODE_INVERSE;
                                isInverse = true;
                            }
                            if(attrMode >= ATTR_MODE_BOLD){
                                attrMode -= ATTR_MODE_BOLD;
                                isBold = true;
                            }
                    }
                    // è§£æattr_mode...end...

                    // åŠ ç²—å’Œæ–œä½“
                    if(isItalic && isBold){
                        current_font_style = DrawFontStyle.BOTH;
                    } else {
                        // æ–œä½“
                        if(isItalic){
                            current_font_style = DrawFontStyle.ITALIC;
                        }
                        // åŠ ç²—
                        if(isBold){
                            current_font_style = DrawFontStyle.BOLD;
                        }
                    }

                    if(current_font_style != DrawFontStyle.NORMAL){
                        // ä¸æ˜¯æ­£å¸¸çš„å­—ä½“
                        this.updateSelectionViewFont(current_font_style);
                    }

                    // console.info("className:" + className + ", color:" + color + ', bgColor:' + bgColor);

                    // å­—ä½“æ–œä½“ï¼Œå­—ä½“åŠ ç²—

                    // this.selectionViewContext.font = this.getFont(block.isItalic, block.isBold);

                    // ç»˜åˆ¶é€‰ä¸­çš„èƒŒæ™¯é¢œè‰²ã€‚
                    if(this._term.preferences.selectionColor.length > 0){
                        selectionColor = this._term.preferences.selectionColor;
                    } else {

                        if(isInverse){
                            // é¢œè‰²åè½¬
                            selectionColor = this._term.preferences.backgroundColor;
                        } else {

                            if(!!color && this._term.preferences.paletteMap[color]){
                                selectionColor = this._term.preferences.paletteMap[color];
                            } else {
                                // é»˜è®¤é¢œè‰²ã€‚
                                selectionColor = this._term.preferences.color;
                            }

                        }


                    }

                    // è®¾ç½®é€‰ä¸­çš„é¢œè‰²ã€‚
                    this.selectionViewContext.fillStyle = selectionColor;
                    this.selectionViewContext.fillRect(startX, startY, charWidth * blocks_char_width[x], this.height);

                    // ç»˜åˆ¶é€‰ä¸­çš„æ–‡æœ¬é¢œè‰²ã€‚
                    if(this._term.preferences.selectionTextColor.length > 0){
                        selectionTextColor = this._term.preferences.selectionTextColor;
                    } else {
                        if(isInverse){
                            // é¢œè‰²åè½¬
                            selectionTextColor = this._term.preferences.color;
                        } else {
                            selectionTextColor = (!!bgColor && this._term.preferences.paletteMap[bgColor]) ?
                                this._term.preferences.paletteMap[bgColor]: this._term.preferences.backgroundColor;
                        }


                    }

                    this.selectionViewContext.fillStyle = selectionTextColor;

                } else {
                    // è®¾ç½®é»˜è®¤çš„å­—ä½“ã€‚
                    // è®¾ç½®é»˜è®¤çš„å­—ä½“ã€‚
                    this.updateSelectionViewFont(DrawFontStyle.NORMAL);

                    selectionColor = this._term.preferences.selectionColor.length > 0 ? this._term.preferences.selectionColor: this._term.preferences.color;
                    selectionTextColor = this._term.preferences.selectionTextColor.length > 0 ? this._term.preferences.selectionTextColor : this._term.preferences.backgroundColor;

                    this.selectionViewContext.fillStyle = selectionColor;
                    this.selectionViewContext.fillRect(startX, startY, charWidth * blocks_char_width[x], this.height);
                    this.selectionViewContext.fillStyle = selectionTextColor;

                }

                // ç”»ä¸‹åˆ’çº¿ï¼Œé«˜åº¦ä¸º2ä¸ªåƒç´ 
                // åˆ¶è¡¨ç¬¦
                // if(value === "\t"){
                //     const tabSize = this._term.preferences.tabSize;
                //     let spCount = tabSize - (charCount % tabSize);
                //
                //     for(let i = 0; i < spCount; i++){
                //         // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
                //         this.selectionViewContext.fillStyle = selectionColor;
                //         this.selectionViewContext.fillRect(startX, startY, charWidth, this.height);
                //         startX += charWidth;
                //         charCount += 1;
                //     }
                //
                //     continue;
                // }

                // ç©ºæ ¼ä¸è¾“å‡ºï¼Œåªå³ç§»ã€‚ä»¥å‡å°‘fillTextçš„è°ƒç”¨æ¬¡æ•°
                if(!isInvisible && blocks_data[x] != " "){
                    this.selectionViewContext.fillText(blocks_data[x], startX, textStartY);
                }

                startX += charWidth * blocks_char_width[x];
                charCount += blocks_char_width[x];

                // drawCursor
                // if(this.activeBuffer.x == x + 1 && this.activeBuffer.y == y + 1){
                //     console.info("ç»˜åˆ¶å…‰æ ‡..");
                //     this.drawCursor(false, selectionColor, selectionTextColor);
                // }

            }

            // return startX;

        }

        // return startX + selectedWidth;

    }

    /**
     * ä»…æ¸…é™¤ç”»å¸ƒ
     * @param selection
     */
    clearRect(selection: CanvasSelection){
        if(this.selectionViewContext) {
            if(/*selection.ranges.length == 0 || */selection.selectAll){
                this.selectionViewContext.clearRect(0,
                    0, this._term.selectionView.width, this._term.selectionView.height);
                return;
            } else {
                for(let range of selection.ranges){
                    // è·å–æ‰€æœ‰é€‰ä¸­çš„èŒƒå›´ã€‚
                    this.selectionViewContext.clearRect(range.startPoint.x,
                        range.startPoint.y, range.realStopX - range.startPoint.x, this.height);
                }
            }
        }
    }

    /**
     * å–æ¶ˆé€‰æ‹©ã€‚
     */
    unselect(selection: CanvasSelection){

        if(!selection.running) return;

        if(this.selectionViewContext){

            console.info(selection);
            // æ¸…é™¤ç”»å¸ƒ
            this.clearRect(selection);

            selection.clearRanges();
            selection.running = false;

            // å–æ¶ˆé€‰ä¸­ã€
            let sel = window.getSelection();
            if(sel){
                sel.removeAllRanges();
            }
            this._term.clipboard.value = "";
        }
    }


    /**
     * å¤„ç†å—é€‰æ‹©
     * @param index
     * @param blocks
     * @param flag
     */
    private handleSelectBlock(index: number, blocks: string[], flag: number): number{

        let chr = blocks[index];
        if(flag == 1) {
            if(CommonUtils.isNumberLetter(chr)) {
                return index;
            } else {
                return -1;
            }
        } else if(flag == 2) {
            if(CommonUtils.isSymbol(chr)) {
                return index;
            } else {
                return -1;
            }
        } else if(flag == 3) {
            if(CommonUtils.isChinese(chr)
                || (chr == "" && CommonUtils.isChinese(blocks[index - 1]))) {
                // ä¸­æ–‡æˆ–ä¸‹ä¸€ä¸ªæ˜¯ä¸­æ–‡çš„å ä½å·
                return index;
            } else {
                return -1;
            }
        } else if(flag == 4) {
            if(CommonUtils.isChineseSymbol(chr)
                || (chr == "" && CommonUtils.isChineseSymbol(blocks[index - 1]))) {
                // ä¸­æ–‡æˆ–ä¸‹ä¸€ä¸ªæ˜¯ä¸­æ–‡çš„å ä½å·
                return index;
            } else {
                return -1;
            }
        } else if(flag == 10){
            // å·¦è¾¹çš„å­—ç¬¦éœ€è¦å¯¹åº”å³è¾¹çš„å­—ç¬¦
            if(/[)}\]>ï¼‰ã€‘ã€ã€‹]/gi.test(chr)){
                return index;
            } else {
                return -1;
            }
        } else if(flag == 11){
            // å³è¾¹çš„å­—ç¬¦éœ€è¦å¯¹åº”å·¦è¾¹çš„å­—ç¬¦ã€‚
            if(/[({\[<ï¼ˆã€ã€Œã€Š]/gi.test(chr)){
                return index;
            } else {
                return -1;
            }
        }
        return -1;
    }

    /**
     * é€‰ä¸­å—ï¼Œä¸»è¦æ˜¯å½“å‰è¡Œï¼ŒåŒå‡»
     * 1ï¼Œå­—æ¯çš„è¯ï¼Œé€‰ä¸­å‰åçš„å­—æ¯ã€‚
     * 2ï¼Œç‰¹æ®Šå­—ç¬¦çš„è¯ï¼Œé€‰ä¸­å‰åçš„ç‰¹æ®Šå­—ç¬¦
     * 3ï¼Œä¸­æ–‡çš„è¯ï¼Œé€‰ä¸­å‰åçš„ä¸­æ–‡
     * @param selection
     */
    selectBlock(selection: CanvasSelection) {

        if(this.selectionViewContext){


            const width = this._measuredTextWidth
                , height = this.height
                // selection.anchorPoint.y = index * heightï¼Œéœ€è¦ç´¢å¼•çš„è¯ï¼Œéœ€è¦é™¤height
                , startYIndex = Math.floor(selection.anchorPoint.y / height)
                , blocks = this.activeBuffer.window_buf.lines[startYIndex];

            let startXIndex = Math.floor(selection.anchorPoint.x / width);
            let selectedChar = blocks[startXIndex];

            if(selectedChar == ""){
                // å†…å­˜å­˜å‚¨ç»“æ„ï¼š["a", "b", "c", "ä¸­", "", "æ–‡", ""]
                // è®¡ç®—åˆ°å½“å‰æ˜¯ä¸­æ–‡å ä½ç¬¦
                // è·å–ä¸Šä¸€ä¸ªä¸­æ–‡
                startXIndex -= 1;
                selectedChar = blocks[startXIndex];
            }

            let flag = 0;
            if(CommonUtils.isNumberLetter(selectedChar)) {
                // æ•°å­— + å­—æ¯
                flag = 1;
            } else if(/[({\[<ï¼ˆã€ã€Œã€Š]/gi.test(selectedChar)){
                // æ•´å¯¹çš„ç‰¹æ®Šå­—ç¬¦(å·¦): (){}[]<>ï¼ˆï¼‰ã€ã€‘ã€Œã€ã€Šã€‹
                flag = 10;
            } else if(/[)}\]>ï¼‰ã€‘ã€ã€‹]/gi.test(selectedChar)){
                // æ•´å¯¹çš„ç‰¹æ®Šå­—ç¬¦(å³): (){}[]<>ï¼ˆï¼‰ã€ã€‘ã€Œã€ã€Šã€‹
                flag = 11;
            } else if(CommonUtils.isSymbol(selectedChar)){
                // ç¬¦å·
                flag = 2;
            } else if(CommonUtils.isChinese(selectedChar)){
                // ä¸­æ–‡
                flag = 3;
            } else if(CommonUtils.isChineseSymbol(selectedChar)){
                // ä¸­æ–‡ç¬¦å·
                flag = 4;
            }

            // å·¦è¾¹æœç´¢
            let leftIndex = startXIndex;
            if(flag != 10){
                // å¦‚æœæ˜¯ç‰¹æ®Šå­—ç¬¦ï¼Œå·¦è¾¹çš„ç¬¦å·
                let ret_index = leftIndex;
                for(let i = startXIndex - 1; 0 <= i; i--){
                    ret_index = this.handleSelectBlock(i, blocks, flag);
                    if(flag == 11){
                        // å³è¾¹ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚)ã€>ã€}ç­‰ã€‚
                        if(ret_index == -1) continue;
                        break;
                    }
                    if(ret_index == -1) break;
                    leftIndex = ret_index;
                }
                // å¤„ç†ç‰¹æ®Šå­—ç¬¦
                if(ret_index != -1) leftIndex = ret_index;
            }

            // å³è¾¹æœç´¢
            let rightIndex = startXIndex;
            if(flag != 11){
                let ret_index = rightIndex;
                for(let i = startXIndex + 1, len = blocks.length; i < len; i++){
                    ret_index = this.handleSelectBlock(i, blocks, flag);
                    if(flag == 10){
                        // å·¦è¾¹ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚(ã€<ã€{ç­‰ã€‚
                        if(ret_index == -1) continue;
                        break;
                    }
                    if(ret_index == -1) break;
                    rightIndex = ret_index;
                }
                // å¤„ç†ç‰¹æ®Šå­—ç¬¦
                if(ret_index != -1) rightIndex = ret_index;
            }

            console.info("leftIndex:" + leftIndex + ", rightIndex:" + rightIndex);

            const selectedContent = blocks.slice(leftIndex, rightIndex + 1);
            const x = leftIndex * width
                , y = startYIndex * height
                , w = (rightIndex - leftIndex + 1) * width;

            console.info("x:" + x + ", y:" + y + ", w:" + w + ", height:" + height);

            // ç»˜åˆ¶é€‰ä¸­çš„é¢œè‰²
            selection.clearRanges();
            // æ­£å¸¸çš„ï¼ŒstopX = x + w, ä½†æ˜¯å¦‚æœå‡ºç°ä¸­æ–‡ç­‰å­—ç¬¦çš„è¯ï¼Œä¸€ä¸ªä¸­æ–‡ = width * 2;
            this.drawSelectedText(x, y, height, width);
            selection.running = true;

            // è§£æé€‰ä¸­çš„æ–‡æœ¬
            let selectedText = this.handleSelectedContent(selectedContent).join("");
            selection.ranges.push(new SelectionRange(x, y, x + w, y, selectedText));

            this._term.clipboard.value = selection.selectedContent;
            this._term.clipboard.select();

            console.info("selectedContent:" + selection.selectedContent);

            console.info(JSON.stringify(selection));

            // æ›´æ–°selection
            // è€ƒè™‘åé¢ä¼šæ»šåŠ¨ï¼Œæ»šåŠ¨è°ƒç”¨selectæ–¹æ³•æ¸²æŸ“
            selection.start(x, y, this._term.getOffsetTop());
            selection.stop(x + w, y);

            console.info(JSON.stringify(selection));

            // 22019aaaa-aaa

        }

    }


    /**
     * é€‰ä¸­ä¸€æ•´è¡Œï¼Œä¸‰å‡»
     * @param selection
     */
    selectLine(selection: CanvasSelection){

        if(this.selectionViewContext){

            const height = this.height
                , width = this._measuredTextWidth
                , fullWidth = this._term.columns * width
                // selection.anchorPoint.y = index * heightï¼Œéœ€è¦ç´¢å¼•çš„è¯ï¼Œéœ€è¦é™¤height
                , startY = selection.anchorPoint.y
                , startYIndex = Math.floor(startY / height)
                , selectedContent = this.activeBuffer.window_buf.lines[startYIndex];

            // ç»˜åˆ¶é€‰ä¸­çš„é¢œè‰²
            selection.clearRanges();
            this.drawSelectedText(0, startY, height, width);
            selection.running = true;
            // è§£æé€‰ä¸­çš„æ–‡æœ¬
            const selectedText = this.handleSelectedContent(selectedContent).join("");
            selection.ranges.push(new SelectionRange(0, startY, fullWidth, startY, selectedText));

            // æ›´æ–°selection
            // è€ƒè™‘åé¢ä¼šæ»šåŠ¨ï¼Œæ»šåŠ¨è°ƒç”¨selectæ–¹æ³•æ¸²æŸ“
            selection.start(0, startY, this._term.getOffsetTop());
            selection.stop(fullWidth, startY);

            this._term.clipboard.value = selection.selectedContent;
            this._term.clipboard.select();

            console.info("selectedContent:" + selection.selectedContent);

        }
    }

    /**
     * å…¨é€‰
     * @param selection
     */
    selectAll(selection: CanvasSelection) {

        if(this.selectionViewContext){

            const width = this._measuredTextWidth
                , height = this.height
                , fullWidth = this._term.columns * width
                , saved_lines = this._term.bufferSet.normal.saved_buf.lines;

            const lineCount = saved_lines.length + this.activeBuffer.size;

            if(lineCount != selection.ranges.length){
                // é€‰ä¸­å…¶ä»–åŒºåŸŸï¼Œéœ€è¦æ¸…æ‰
                selection.clearRanges();

                // è¿™å—æ˜¯æ»šåŠ¨åŒºä¿å­˜çš„è¡Œã€‚
                for(const blocks of saved_lines){
                    if(!blocks) continue;
                    // è§£æé€‰ä¸­çš„æ–‡æœ¬
                    const selectedText = this.handleSelectedContent(blocks).join("");
                    selection.ranges.push(new SelectionRange(0, 0, 0, 0, selectedText));
                }

                // è¿™å—æ˜¯ç¼“å†²åŒºçš„è¡Œ
                for(const blocks of this.activeBuffer.change_buf.lines){
                    if(!blocks) continue;
                    // è§£æé€‰ä¸­çš„æ–‡æœ¬
                    const selectedText = this.handleSelectedContent(blocks).join("");
                    selection.ranges.push(new SelectionRange(0, 0, 0, 0, selectedText));
                }
            }

            this.clearRect(selection);

            // æ¸²æŸ“æ˜¾ç¤ºå†…å®¹
            for(let y = 0, len = this.activeBuffer.size; y < len; y++){
                this.drawSelectedText(0, y * height, height, width);
            }

            selection.running = true;
            selection.selectAll = true;

            this._term.clipboard.value = selection.selectedContent;
            this._term.clipboard.select();
        }


    }


    /**
     * å¤„ç†çª—å£ç¼©æ”¾ï¼Œæ»šåŠ¨æ—¶å€™çš„é€‰ä¸­å†…å®¹ã€‚
     */
    handleSelect(): number{

        // ä»€ä¹ˆéƒ½æ²¡æœ‰é€‰ä¸­
        if(!this._term.selection.running){
            return 0;
        }

        // å…¨é€‰ã€‚
        // å…¨é€‰çš„æ—¶å€™ï¼Œä¸ç”¨æ¸²æŸ“å†…å®¹ã€‚
        if(this._term.selection.selectAll){
            this.selectAll(this._term.selection);
            return 1;
        } else {
            // éƒ¨åˆ†é€‰ä¸­
            this.select2(this._term.selection);
            return 2;
        }
    }

}